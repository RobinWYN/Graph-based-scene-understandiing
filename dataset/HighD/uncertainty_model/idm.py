from typing import Tuple
import numpy as np
import math
from scipy import optimize
from random import uniform


def idm_fitting(x_3d, a_max, v_e, T, b_max):
    v = x_3d[0]
    s = x_3d[1]
    dv = x_3d[2]
    b_max *= 2
    T /= 2.0

    s_tmp0 = 2 * math.sqrt(abs(a_max * b_max))
    # print(s_tmp0)
    s_tmp1 = v * T + v * dv / s_tmp0
    # print(np.shape(s_tmp1))
    s_tmp2 = np.stack((np.zeros_like(s_tmp1.T), s_tmp1.T), axis=0)
    # print(np.shape(s_tmp2))
    s_e = 2 + np.max(s_tmp2, axis=0)
    # print(np.shape(s_e))
    a = a_max * (1 - (v / v_e) ** 4 - (s_e / s)) ** 2
    return a


class IDM:
    def __init__(
        self,
        duration: int,
        rate: int,
        a: np.array,
        v: np.array,
        dhw: np.array,
        dv: np.array,
    ):
        self.duration = duration
        self.rate = rate
        self.frameNum = duration * rate
        self.a = a  # acceleration for ego car
        self.v = v  # velocity for ego car
        self.dhw = dhw  # distance of headway (front car minus ego car)
        self.dv = dv  # delta velocity

    def fit(self) -> Tuple[float, float, float, float]:
        print(
            f"get average a: {np.mean(self.a):.2f}, v: {np.mean(self.v):.2f}, dhw: {np.mean(self.dhw):.2f}, dv: {np.mean(self.dv):.2f}, "
        )
        input = np.stack((self.v, self.dhw, self.dv), axis=0)
        # print(np.shape(input))
        a_max, v_e, T, b = optimize.curve_fit(
            idm_fitting,
            input,
            self.a,
            maxfev=100000,
            p0=[0.73, 30, 1.5, 1.67],
            bounds=([0.5, 20, 0.5, 0.5], [2, 70, 3, 3]),
        )[0]
        a_max += uniform(-0.1, 0.1)
        v_e += uniform(-1, 1)
        T += uniform(-0.1, 0.1)
        b += uniform(-0.1, 0.1)
        print(f"fit a_max: {a_max:.2f}, v_e: {v_e:.2f}, T: {T:.2f}, b: {b:.2f}")
        return a_max, v_e, T, b
        # return 0, 0, 0, 0


if __name__ == "__main__":
    a1 = [
        0.13,
        0.14,
        0.14,
        0.14,
        0.15,
        0.15,
        0.15,
        0.15,
        0.16,
        0.16,
        0.16,
        0.16,
        0.17,
        0.17,
        0.17,
        0.17,
        0.17,
        0.18,
        0.18,
        0.18,
        0.18,
        0.18,
        0.18,
        0.18,
        0.19,
        0.19,
        0.19,
        0.19,
        0.19,
        0.2,
        0.2,
        0.2,
        0.2,
        0.2,
        0.21,
        0.21,
        0.21,
        0.21,
        0.21,
        0.21,
        0.22,
        0.22,
        0.22,
        0.22,
        0.22,
        0.22,
        0.22,
        0.23,
        0.23,
        0.23,
        0.23,
        0.23,
        0.23,
        0.23,
        0.23,
        0.23,
        0.23,
        0.23,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
        0.24,
    ]
    v1 = [
        35.81,
        35.82,
        35.82,
        35.83,
        35.84,
        35.84,
        35.85,
        35.85,
        35.86,
        35.87,
        35.87,
        35.88,
        35.89,
        35.89,
        35.9,
        35.91,
        35.91,
        35.92,
        35.93,
        35.93,
        35.94,
        35.95,
        35.96,
        35.96,
        35.97,
        35.98,
        35.98,
        35.99,
        36.0,
        36.01,
        36.02,
        36.02,
        36.03,
        36.04,
        36.05,
        36.06,
        36.06,
        36.07,
        36.08,
        36.09,
        36.1,
        36.11,
        36.12,
        36.12,
        36.13,
        36.14,
        36.15,
        36.16,
        36.17,
        36.18,
        36.19,
        36.2,
        36.21,
        36.22,
        36.22,
        36.23,
        36.24,
        36.25,
        36.26,
        36.27,
        36.28,
        36.29,
        36.3,
        36.31,
        36.32,
        36.33,
        36.34,
        36.35,
        36.36,
        36.37,
        36.38,
        36.39,
        36.4,
        36.41,
        36.42,
    ]
    dhw1 = [
        134.0,
        133.88,
        133.76,
        133.64,
        133.52,
        133.4,
        133.29,
        133.16,
        133.03,
        132.9,
        132.78,
        132.65,
        132.52,
        132.41,
        132.3,
        132.19,
        132.08,
        131.97,
        131.85,
        131.73,
        131.61,
        131.49,
        131.37,
        131.26,
        131.14,
        131.03,
        130.92,
        130.81,
        130.7,
        130.58,
        130.47,
        130.35,
        130.23,
        130.11,
        129.99,
        129.88,
        129.76,
        129.65,
        129.54,
        129.44,
        129.33,
        129.22,
        129.12,
        129.01,
        128.9,
        128.78,
        128.67,
        128.56,
        128.45,
        128.33,
        128.22,
        128.11,
        128.01,
        127.89,
        127.79,
        127.68,
        127.56,
        127.45,
        127.33,
        127.23,
        127.12,
        127.0,
        126.89,
        126.79,
        126.68,
        126.57,
        126.46,
        126.35,
        126.25,
        126.14,
        126.04,
        125.95,
        125.84,
        125.73,
        125.62,
    ]
    dv1 = [
        -3.1,
        -3.09,
        -3.08,
        -3.08,
        -3.07,
        -3.06,
        -3.05,
        -3.04,
        -3.04,
        -3.03,
        -3.02,
        -3.01,
        -3.01,
        -2.99,
        -2.99,
        -2.98,
        -2.97,
        -2.96,
        -2.96,
        -2.94,
        -2.94,
        -2.93,
        -2.93,
        -2.92,
        -2.91,
        -2.91,
        -2.89,
        -2.89,
        -2.88,
        -2.88,
        -2.87,
        -2.86,
        -2.85,
        -2.85,
        -2.85,
        -2.84,
        -2.83,
        -2.82,
        -2.82,
        -2.81,
        -2.81,
        -2.81,
        -2.8,
        -2.79,
        -2.78,
        -2.78,
        -2.77,
        -2.77,
        -2.77,
        -2.76,
        -2.76,
        -2.76,
        -2.75,
        -2.75,
        -2.73,
        -2.73,
        -2.73,
        -2.72,
        -2.72,
        -2.71,
        -2.71,
        -2.71,
        -2.7,
        -2.7,
        -2.69,
        -2.69,
        -2.69,
        -2.68,
        -2.68,
        -2.67,
        -2.67,
        -2.67,
        -2.66,
        -2.66,
        -2.66,
    ]
    idm1 = IDM(3, 25, np.array(a1), np.array(v1), np.array(dhw1), np.array(dv1))

    a2 = [
        -0.18,
        -0.19,
        -0.19,
        -0.19,
        -0.19,
        -0.19,
        -0.19,
        -0.19,
        -0.19,
        -0.19,
        -0.18,
        -0.18,
        -0.18,
        -0.18,
        -0.18,
        -0.18,
        -0.18,
        -0.18,
        -0.18,
        -0.18,
        -0.17,
        -0.17,
        -0.17,
        -0.17,
        -0.17,
        -0.17,
        -0.17,
        -0.17,
        -0.17,
        -0.17,
        -0.16,
        -0.16,
        -0.16,
        -0.16,
        -0.16,
        -0.16,
        -0.15,
        -0.15,
        -0.15,
        -0.15,
        -0.15,
        -0.14,
        -0.14,
        -0.14,
        -0.14,
        -0.13,
        -0.13,
        -0.13,
        -0.12,
        -0.12,
        -0.12,
        -0.11,
        -0.11,
        -0.11,
        -0.1,
        -0.1,
        -0.1,
        -0.1,
        -0.09,
        -0.09,
        -0.09,
        -0.09,
        -0.09,
        -0.08,
        -0.08,
        -0.08,
        -0.08,
        -0.08,
        -0.07,
        -0.07,
        -0.07,
        -0.07,
        -0.07,
        -0.07,
        -0.07,
    ]
    v2 = [
        -36.06,
        -36.07,
        -36.07,
        -36.08,
        -36.09,
        -36.1,
        -36.1,
        -36.11,
        -36.12,
        -36.13,
        -36.13,
        -36.14,
        -36.15,
        -36.15,
        -36.16,
        -36.17,
        -36.18,
        -36.18,
        -36.19,
        -36.2,
        -36.2,
        -36.21,
        -36.22,
        -36.23,
        -36.23,
        -36.24,
        -36.25,
        -36.25,
        -36.26,
        -36.27,
        -36.27,
        -36.28,
        -36.29,
        -36.29,
        -36.3,
        -36.31,
        -36.31,
        -36.32,
        -36.32,
        -36.33,
        -36.34,
        -36.34,
        -36.35,
        -36.35,
        -36.36,
        -36.36,
        -36.37,
        -36.38,
        -36.38,
        -36.39,
        -36.39,
        -36.39,
        -36.4,
        -36.4,
        -36.41,
        -36.41,
        -36.42,
        -36.42,
        -36.42,
        -36.43,
        -36.43,
        -36.43,
        -36.44,
        -36.44,
        -36.44,
        -36.45,
        -36.45,
        -36.45,
        -36.46,
        -36.46,
        -36.46,
        -36.47,
        -36.47,
        -36.47,
        -36.47,
    ]
    dhw2 = [
        70.85,
        70.67,
        70.48,
        70.3,
        70.11,
        69.93,
        69.76,
        69.58,
        69.41,
        69.23,
        69.05,
        68.87,
        68.69,
        68.51,
        68.33,
        68.16,
        67.98,
        67.79,
        67.61,
        67.43,
        67.24,
        67.05,
        66.86,
        66.67,
        66.48,
        66.29,
        66.1,
        65.91,
        65.72,
        65.52,
        65.34,
        65.14,
        64.95,
        64.76,
        64.56,
        64.37,
        64.18,
        63.99,
        63.8,
        63.61,
        63.42,
        63.22,
        63.03,
        62.84,
        62.64,
        62.44,
        62.25,
        62.05,
        61.85,
        61.64,
        61.44,
        61.25,
        61.06,
        60.87,
        60.66,
        60.47,
        60.27,
        60.07,
        59.87,
        59.67,
        59.46,
        59.26,
        59.05,
        58.84,
        58.64,
        58.43,
        58.23,
        58.03,
        57.83,
        57.63,
        57.43,
        57.23,
        57.02,
        56.81,
        56.6,
    ]
    dv2 = [
        4.63,
        4.63,
        4.63,
        4.63,
        4.63,
        4.64,
        4.63,
        4.63,
        4.64,
        4.64,
        4.64,
        4.65,
        4.65,
        4.65,
        4.65,
        4.66,
        4.67,
        4.67,
        4.68,
        4.68,
        4.68,
        4.69,
        4.7,
        4.71,
        4.71,
        4.72,
        4.73,
        4.73,
        4.74,
        4.75,
        4.75,
        4.76,
        4.77,
        4.78,
        4.79,
        4.8,
        4.8,
        4.81,
        4.82,
        4.83,
        4.84,
        4.84,
        4.86,
        4.86,
        4.87,
        4.87,
        4.89,
        4.9,
        4.91,
        4.92,
        4.92,
        4.93,
        4.94,
        4.95,
        4.96,
        4.96,
        4.98,
        4.98,
        4.99,
        5.0,
        5.01,
        5.01,
        5.03,
        5.03,
        5.04,
        5.05,
        5.06,
        5.06,
        5.08,
        5.08,
        5.09,
        5.1,
        5.11,
        5.11,
        5.12,
    ]
    idm2 = IDM(3, 25, np.array(a2), np.array(v2), np.array(dhw2), np.array(dv2))

    print(idm1.fit())
    print(idm2.fit())
